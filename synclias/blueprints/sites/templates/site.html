{% extends "base.html" %}

{% block title %}Synclias{% endblock %}

{% block page_content %}

    <!-- Modal for Adding Site-->
    <div class="modal fade" id="add-site-modal" tabindex="-1" aria-labelledby="add-site-modal-label" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="add-site-modal-label">Add Routed Site</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form action="{{url_for('sites.site')}}" method="post">
            {{ add_site_form.hidden_tag() }}
            <div class="modal-body">
              <div class="form-group row">
                {{ add_site_form.url.label }}
                <!-- <label for="url" class="col-xs-2 control-label">URL</label> -->
                <div class="col-xs-10">
                    {{ add_site_form.url(size=32,class="form-control") }}
                  
                    {% for error in add_site_form.url.errors %}
                    <span style="color: red;">[{{ error }}]</span>
                    {% endfor %}

              <!-- <input type="text" id="url" class="form-control" name="url" placeholder="www.site.com" /> -->
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="submit" class="btn btn-success">Add</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <!-- Modal End: Add Site-->

      </br>
      <h1>VPN Routed Sites</h1>

      <p>Note: Only complete URLs will work (no wildcards!)</p>

      <div class="row">
        <div class="col-md-2">
          <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#add-site-modal">
            Add Site
          </button>
        </div>
        <div class="col-md-3">
          <button type="submit" form="form-select-sites" class="btn btn-danger">Delete Selected</button>
        </div>
        
        <div class="col-md-4">
        </div>
      </div>
    </br>

      


      <div class="row">
        <div class="col-md-8">
          <form id="form-select-sites" action="{{url_for('sites.delete_bulk')}}" method="post">
            <table class="table table-striped" border="1">
              <thead>
                <tr>
                  <th>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="" onclick=toggle_selection(this.id,this.checked) name="check-all" id="check-all">
                        <label class="form-check-label" for="flexCheckDefault"></label>
                    </div>
                  </th>
                  <th>Site</th>
                  <th>Site Group</th>
                  <th>Scan on Sync?</th>
                  <th>Override Safety Keywords?</th>
                  <th>Also use Historical DNS?</th>
                  <!-- <th colspan="2">Action</th> -->
                </tr>
              </thead>
              <tbody>
                {% for site in sites %}
                <tr>
                  <!-- <td>{{ site.id }}</td> -->
                  <td>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="" name="select-{{site.id}}" id="select-{{site.id}}">
                        <label class="form-check-label" for="flexCheckDefault"></label>
                    </div>
                  </td>
                  <td>{{ site.url }}</td>
                  <td>{{ site.url_group }}</td>
                  <td>
                    <div class="form-check form-switch">
                      {% if site.crawl is true %}
                      <input class="form-check-input" type="checkbox" onclick="toggle_property(this.id, this.checked)" name="crawl-{{site.id}}" id="crawl-{{site.id}}" checked="checked">
                      {% else %}
                      <input class="form-check-input" type="checkbox" onclick="toggle_property(this.id, this.checked)" name="crawl-{{site.id}}" id="crawl-{{site.id}}" >
                      {% endif %}
                    </div>
                  </td>
                  <td>
                    <div class="form-check form-switch">
                      {% if site.override_safety is true %}
                      <input class="form-check-input" type="checkbox" onclick="toggle_property(this.id, this.checked)" name="override_safety-{{ site.id}}" id="override_safety-{{ site.id}}" checked="checked">
                      {% else %}
                      <input class="form-check-input" type="checkbox" onclick="toggle_property(this.id, this.checked)" name="override_safety-{{ site.id}}" id="override_safety-{{ site.id}}" >
                      {% endif %}
                    </div>
                  </td>
                  <td>
                    <div class="form-check form-switch">
                      {% if site.use_dns_history is true %}
                      <input class="form-check-input" type="checkbox" onclick="toggle_property(this.id, this.checked)" name="use_dns_history-{{ site.id}}" id="use_dns_history-{{ site.id}}" checked="checked">
                      {% else %}
                      <input class="form-check-input" type="checkbox" onclick="toggle_property(this.id, this.checked)" name="use_dns_history-{{ site.id}}" id="use_dns_history-{{ site.id}}" >
                      {% endif %}
                    </div>
                  </td>
                  <!-- <td><button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#delete-site-modal_{{ site.id}}">Delete</button></td> -->
              
                  <!-- Modal for deleting a site -->
                  <div class="modal fade" id="delete-site-modal_{{ site.id}}" tabindex="-1" aria-labelledby="delete-site-modal-label" aria-hidden="true">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="delete-site-modal-label">Delete Site</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <form action="{{url_for('sites.delete', id=site.id)}}" method="post" name="delete-site-modal-form" id="delete-site-modal-form">
                          <div class="modal-body">
                            <div class="form-group row">
                              <label class="col-sm-12 col-form-label">Do you want to delete the site <spa style='font-weight:bold;color:red'>{{site.url}}</span>?</label>
                            </div>
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-bs-dismiss="modal">Close</button>
                            <button type="submit" form="delete-site-modal-form" class="btn btn-danger">Delete</button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>
                      <!-- End Modal-->
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </form>
        </div>
      </div>
      <div class="col-md-8">
          <nav aria-label="..."> 
        <ul class="pagination justify-content-end">
          <li class="page-item  {{'disabled' if not prev_url}}">
            <a class="page-link" href="{{ prev_url }}">Prev</a>
          </li>

          {% for page_no in range(sites.pages) %}
            <!-- {{ sites.page }} -->
            {% if loop.index == sites.page %}
              <li class="page-item active"> <span class="page-link"> {{ loop.index }} </span> </li>
              <!-- {{ loop.index }} -->
            {% else %}
              <li class="page-item" ><a class="page-link" href="{{ url_for('sites.site', page= loop.index) }}">{{ loop.index }}</a></li>
            {% endif%}
          {% endfor %}
          <li class="page-item  {{'disabled' if not next_url}}">
            <a class="page-link" href="{{ next_url }}">Next</a>
          </li>
        </ul>
      </nav>
        </div>




{% endblock %}

{% block scripts %}

    {{ super() }}

    <script>

      // checkbox for "select all"
      function toggle_selection(id,checked){
        $("[name^='select-']").each(function(){
          this.checked = checked
        })
      }

      // Ajax PUT for any of the toggle switches to modify settings in db
      function toggle_property(id,state){
        const splitArray = id.split("-");
        // I know I'm converting True to 0/1, and it's a newbie error
        state === true ? state_int = 1 : state_int = 0

        url = "/site/" + splitArray[0] + "/" + splitArray[1] + "/" + state_int;
        $.ajax({
          type: 'PUT',
          url: url, 
        });
      }
     
    </script>

{% endblock %}